<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>profile</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css"
      integrity="sha512-kJlvECunwXftkPwyvHbclArO8wszgBGisiLeuDFwNM8ws+wKIw0sv1os3ClWZOcrEB2eRXULYUsm8OVRGJKwGA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="./style/home.css" />
    <link rel="stylesheet" href="./style/profile.css" />
  </head>
  <body>
    <!-- Global Loading Overlay -->
    <!-- <div class="loading-overlay hidden" id="globalLoadingOverlay">
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading your blogs...</div>
      </div>
    </div> -->

    <div class="help-card hidden">
      <h3 style="margin-top: 0">Need help?</h3>
      <span>
        Welcome to <strong>BlogZone</strong>! Here you can read, write, and
        share blogs with the community.<br /><br />
        <ul style="padding-left: 18px; margin: 0">
          <li>Use the <b>Write</b> button to create a new blog post.</li>
          <li>
            Click your profile image to manage your account or copy your profile
            link.
          </li>
          <li>Bookmark your favorite blogs for quick access.</li>
          <li>Check your stats to see your blog performance.</li>
        </ul>
        <br />
        For more help, contact us via the links in the footer.
      </span>
    </div>
    <div class="profile-card hidden">
      <div class="userinfo">
        <img src="./assets/my-av.jpeg" alt="User Avatar" />
        <div>
          <div class="fullname">Loading...</div>
          <div class="email">Loading...</div>
        </div>
      </div>
      <div class="btns">
        <a href="profile.html" class="btn"
          ><i class="ri-user-settings-fill"></i> Manage account</a
        >
        <a href="#" class="btn" onclick="logout()"
          ><i class="fa-solid fa-right-from-bracket"></i> Logout</a
        >
      </div>
      <div class="links">
        <button
          class="btn"
          onclick="copyToClipboard(event, 'https://blogzone.com/@loading')"
          style="
            background: none;
            border: none;
            color: #cacfd9;
            cursor: pointer;
          "
        >
          https://blogzone.com/@loading <i class="ri-clipboard-fill"></i>
        </button>
      </div>
    </div>
    <nav>
      <a href="index.html">
        <div class="logo">
          <i class="fa-solid fa-blog"></i>
          <div class="name">BlogZone</div>
        </div>
      </a>
      <div class="search">
        <div class="icon">
          <i class="fa-solid fa-magnifying-glass"></i>
        </div>
        <div class="searchbar">
          <input type="search" placeholder="| Search your blog..." />
        </div>
      </div>
      <div class="nav-list">
        <div
          class="write-blog"
          onclick="window.location.href='./create-blog.html'"
        >
          <div class="icon">
            <i class="fa-regular fa-pen-to-square"></i>
          </div>
          <span>Write</span>
        </div>
        <div class="help" onclick="showHelpCard()">
          <i class="fa-solid fa-circle-info"></i>
        </div>
        <div class="profile" onclick="showCard()">
          <img src="./assets/my-av.jpeg" alt="" />
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="sidebar">
        <ul class="topbar">
          <li onclick="window.location.href='home.html'">
            <i class="fa-solid fa-house"></i> Home
          </li>
          <li onclick="window.location.href='bookmark.html'">
            <i class="fa-solid fa-bookmark"></i> Bookmark
          </li>
          <li class="active"><i class="fa-solid fa-user"></i> Profile</li>
          <li onclick="window.location.href='stat.html'">
            <i class="fa-solid fa-chart-simple"></i> Stats
          </li>
        </ul>
        <ul class="bottombar" onclick="logout()">
          <li><i class="fa-solid fa-right-from-bracket"></i> Logout</li>
        </ul>
      </div>

      <div class="content">
        <div class="profileCards" id="profileCards">
          <div class="profileUpperLayer">
            <div class="image">
              <img src="./assets/my-av.jpeg" alt="User Avatar" />
            </div>
            <div class="userData">
              <h2 class="username">Loading...</h2>
              <p class="userId">loading...</p>
            </div>
          </div>
        </div>
        <div id="OwnBlogs">
          <div class="cards" id="cards">
            <!-- Card will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </body>

  <script type="module" src="./src/js/home.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const params = new URLSearchParams(window.location.search);
      const username = params.get("username");
      if (username) {
        // Show another user's profile
        try {
          // Fetch profile
          const profileRes = await fetch(
            `http://localhost:8080/api/user/profile/${username}`
          );
          if (!profileRes.ok) throw new Error("User not found");
          const profile = await profileRes.json();
          // Update profile card
          document.querySelector(".profileUpperLayer img").src =
            profile.avatar || "./assets/my-av.jpeg";
          document.querySelector(".profileUpperLayer .username").textContent =
            profile.name || username;
          document.querySelector(".profileUpperLayer .userId").textContent =
            "@" + (profile.username || username);
          // Hide manage account/logout buttons for other users
          document.querySelector(".btns").style.display = "none";
          // Update profile-card info
          document.querySelector(".profile-card .fullname").textContent =
            profile.name || username;
          document.querySelector(".profile-card .email").textContent =
            profile.email || "";
          // Update copy link button
          const copyBtn = document.querySelector(".profile-card .links button");
          copyBtn.textContent = `https://blogzone.com/@${
            profile.username || username
          } `;
          copyBtn.onclick = function (e) {
            copyToClipboard(
              e,
              `https://blogzone.com/@${profile.username || username}`
            );
          };

          // Fetch and show blogs by this user
          const blogsRes = await fetch(
            `http://localhost:8080/api/product/author/${username}`
          );
          if (blogsRes.ok) {
            const blogs = await blogsRes.json();

            const cardsDiv = document.getElementById("cards");
            cardsDiv.innerHTML = "";
            if (blogs.length === 0) {
              cardsDiv.innerHTML =
                '<div style="color:#aaa;padding:2rem 0;">No blogs by this user.</div>';
            } else {
              const formattedBlogs = blogs.map((post) => ({
                id: post._id,
                title: post.title,
                desc:
                  post.desc && post.desc.length > 234
                    ? post.desc.substring(0, 234) + "..."
                    : post.desc,
                banner: post.banner,
                avatar: post.author?.avatar || "./assets/my-av.jpeg",
                fullname: post.author?.name || "Anonymous",
                username: post.author?.username
                  ? `@${post.author.username}`
                  : `@${post.author?.email?.split("@")[0] || "anonymous"}`,
                isVerified: post.author?.isVerified || false,
                readTime: post.readTime || "5 min read",
                likes: post.likes || 0,
                bookmarked: false, // If you want true/false per user, adjust from backend
              }));

              // Correct card renderer
              function renderCard(data) {
                return `
              <div class="card" style="margin-top: 20px" data-blog-id="${
                data.id
              }">
                <a class="heading" href="blog.html?id=${data.id}">
                  <h2>${data.title}</h2>
                  <span class="moreIcon"></span>
                </a>
                <div class="profile-section">
                  <img src="${data.avatar}" alt="Author avatar" />
                  <div class="userinfo">
                    <div class="fullname">
                      ${data.fullname}
                      ${
                        data.isVerified
                          ? '<i class="ri-verified-badge-fill" style="color: #0254f7"></i>'
                          : ""
                      }
                    </div>
                    <div class="username">${data.username}</div>
                  </div>
                </div>
                <div class="desc-img">
                  <a href="blog.html?id=${data.id}">
                    <div class="desc">${data.desc}</div>
                  </a>
                  <a href="blog.html?id=${data.id}">
                    <img src="${data.banner}" alt="Blog banner" />
                  </a>
                </div>
                <div class="footer">
                  <div class="fcard ml-20 fcard-like">
                    <i class="fa-solid fa-thumbs-up"></i> Like (${data.likes})
                  </div>
                  <div class="fcard fcard-bookmark">
                    <i class="fa-solid fa-bookmark" ${
                      data.bookmarked ? 'style="color: #f59e0b;"' : ""
                    }></i>
                    ${data.bookmarked ? "Bookmarked" : "Bookmark"}
                  </div>
                  <div class="fcard fcard-share">
                    <i class="fa-solid fa-share-from-square"></i> Share
                  </div>
                  <div class="fcard mr-20">
                    <i class="fa-regular fa-clock"></i> ${data.readTime}
                  </div>
                </div>
              </div>
            `;
              }
              cardsDiv.innerHTML = formattedBlogs.map(renderCard).join("");

              // EVENT DELEGATION for Like/Bookmark/Share
              cardsDiv.addEventListener("click", async function (e) {
                const card = e.target.closest(".card");
                if (!card) return;
                const blogId = card.getAttribute("data-blog-id");
                const userEmail = localStorage.getItem("userEmail");

                // LIKE
                if (e.target.closest(".fcard-like")) {
                  e.preventDefault();
                  const likeBtn = card.querySelector(".fcard-like");
                  const originalLikeHtml = likeBtn.innerHTML;
                  likeBtn.innerHTML =
                    '<i class="fa-solid fa-spinner fa-spin"></i> Liking...';
                  try {
                    const res = await fetch(
                      "http://localhost:8080/api/product/like",
                      {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ blogId, email: userEmail }),
                      }
                    );
                    if (res.ok) {
                      const resp = await res.json();
                      // Update likes number in button
                      likeBtn.innerHTML = `<i class="fa-solid fa-thumbs-up"></i> Like (${resp.likes})`;
                    } else {
                      likeBtn.innerHTML = originalLikeHtml;
                      alert("Failed to like blog.");
                    }
                  } catch (err) {
                    likeBtn.innerHTML = originalLikeHtml;
                    alert("Error liking blog.");
                  }
                  return;
                }

                // BOOKMARK
                if (e.target.closest(".fcard-bookmark")) {
                  e.preventDefault();
                  const bookmarkBtn = card.querySelector(".fcard-bookmark");
                  const originalBookmarkHtml = bookmarkBtn.innerHTML;
                  bookmarkBtn.innerHTML =
                    '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
                  try {
                    const res = await fetch(
                      "http://localhost:8080/api/product/bookmark",
                      {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ blogId, email: userEmail }),
                      }
                    );
                    if (res.ok) {
                      const resp = await res.json();
                      // Toggle bookmark color and text
                      if (resp.bookmarked) {
                        bookmarkBtn.innerHTML =
                          '<i class="fa-solid fa-bookmark" style="color: #f59e0b;"></i> Bookmarked';
                      } else {
                        bookmarkBtn.innerHTML =
                          '<i class="fa-solid fa-bookmark"></i> Bookmark';
                      }
                    } else {
                      bookmarkBtn.innerHTML = originalBookmarkHtml;
                      alert("Failed to bookmark blog.");
                    }
                  } catch (err) {
                    bookmarkBtn.innerHTML = originalBookmarkHtml;
                    alert("Error bookmarking blog.");
                  }
                  return;
                }

                // SHARE
                if (e.target.closest(".fcard-share")) {
                  e.preventDefault();
                  const blogLink = card.querySelector(
                    'a[href*="blog.html?id="]'
                  );
                  const titleElement = card.querySelector("h2");
                  if (!blogLink || !titleElement) return;
                  const blogUrl = new URL(blogLink.href, window.location.origin)
                    .href;
                  const blogTitle = titleElement.textContent;
                  if (navigator.share) {
                    try {
                      await navigator.share({
                        title: blogTitle,
                        text: `Check out this blog: ${blogTitle}`,
                        url: blogUrl,
                      });
                    } catch (err) {
                      /* ignore user dismiss */
                    }
                  } else {
                    await navigator.clipboard.writeText(blogUrl);
                    showSuccessMessage("Blog link copied to clipboard!");
                  }
                  return;
                }
              });
            }
          }
        } catch (err) {
          document.querySelector(".profileUpperLayer .username").textContent =
            "User not found";
          document.getElementById("cards").innerHTML =
            '<div style="color:#aaa;padding:2rem 0;">No blogs found.</div>';
        }
      } else {
        // Show own profile (default behavior, let user-profile.js/home.js handle it)
      }
    });

    // Utility: Copy to clipboard with toast
    function copyToClipboard(e, text) {
      e.preventDefault();
      navigator.clipboard
        .writeText(text)
        .then(() => showSuccessMessage("Copied to clipboard!"))
        .catch(() => alert("Failed to copy!"));
    }
    // Success message toast
    function showSuccessMessage(message) {
      if (!document.getElementById("toast-styles")) {
        const style = document.createElement("style");
        style.id = "toast-styles";
        style.textContent = `
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    `;
        document.head.appendChild(style);
      }
      const toast = document.createElement("div");
      toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 500;
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = "slideOut 0.3s ease-in";
        setTimeout(() => toast.remove(), 300);
      }, 2700);
    }
  </script>

  <script src="./src/js/user-profile.js"></script>
</html>
